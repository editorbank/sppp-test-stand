# Тестовый стенд сервиса проверки прав пользователей

## Цель

* Демонстрация построения отказоустойчивой системы.
* Проверка поведения системы при разных случаях отказа компонент.
* Отладка и тестирование конфигурационных файлов для Nginx.
* Тестовый стенд для разработчиков приложений и компонентов элементов этого сервиса.

## Введение

Компонентная схема стенда.
 ![doc/sppp-test-stand.png](doc/sppp-test-stand.png)
Стенд состоит из семи компонент реализованных на экземплярах серверов Nginx.

Принципиальная схема.
 ![doc/schematic_diagram.png](doc/schematic_diagram.png)
* Запрос от браузера пользователя (0) поступает в некоторую централизованную систему доступа,
 в нашем случае она обозначена на схеме как `Webseal`. В ней происходит аутентификация пользователей.
* Далее запрос (1) передается прикладной прокси сервер (на схеме `Nginx`). В HTTP-заголовке `iv-user` сервер `Webseal`
 передает логин аутентифицированного пользователя.
* Для каждого поступившего запроса на `Nginx` выполняется подзапрос к Сервису проверки прав пользователя (СППП) с целью 
определения его прав на конкретные действия. В этом подзапросе (2) передаются заголовки `iv-user`, `iv-method` и 
сам `URI` исходного запроса без его тела. С учетом спецификации использования RESTful API этих данных достаточно что-бы
определить права пользователя для выполнения запроса.
* В ответе (3) СППП отправляет HTTP-статус, в диаппазоне от 200-299 считается доступ разрешенным,
при всех других доступ запрещается.

  

## Настройка для ОС Windows
 Для нормальной работы командных файлов в этом проекте нужны следующие условия:
* Файл `nginx.exe` положите в эту (корневую) директорию проекта.
Я ипользовал [nginx версии 1.17.10](https://nginx.org/download/nginx-1.17.10.zip).
Если понадобиться настройте для него брандмауер.
* Чтоб в путях был `curl.exe` - из комплекта утилит что поставляются с [Git for Windows](https://git-scm.com/download/win)
* Стенд работоспособен без Административных у пользователя под которым происходит тестирование.

## Описание коммандных файлов

* `all-start.cmd` - Стартует все Nginx-сервера. Можно запускать повторно.

* `all-test.cmd` - Запуск всех тестов (`test-*.cmd`).

* `all-stop.cmd` - Штатная отановка серверов.
* `all-kill.cmd` - Принудительная отановка всех Nginx-процессов.
* `all-clean.cmd` - Очистка логов и временных файлов.
* `all-reload.cmd` - Перечитывание конфигурационных файлов Nginx без прерывания обслуживания клиентов.

* `*\nginx.cmd` - Слегка модифицированный вариант интерфейса запуска `nginx.exe`.
При запуске без параметров ничего не делает. Старт сервера происходит командой `nginx -s start` (что на мой взгляд более логично).
Если при запуске присутствует файл `.\logs\nginx.pid` считается что этот экземпляр сервера уже запущен.
* `*\conf\r.cmd` - перезапуск текущего экземпляра